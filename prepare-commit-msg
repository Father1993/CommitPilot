#!/bin/sh
#
# Git hook –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–æ–º–º–∏—Ç–∞
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞: cp prepare-commit-msg /–ø—É—Ç—å/–∫/–≤–∞—à–µ–º—É/–ø—Ä–æ–µ–∫—Ç—É/.git/hooks/
#

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ —Å–∫—Ä–∏–ø—Ç—É - –µ—Å—Ç—å –¥–≤–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞:
# 1. –í —Ç–µ–∫—É—â–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ CommitPilot
# 2. –í –¥—Ä—É–≥–æ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏, –≥–¥–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω hook
if [ -f "$(dirname "$0")/../auto_commit.py" ]; then
    # –î–ª—è CommitPilot —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
    SCRIPT_PATH="$(dirname "$0")/../auto_commit.py"
elif [ -f "$(dirname "$0")/../../CommitPilot/auto_commit.py" ]; then
    # –î–ª—è —Å–ª—É—á–∞—è, –∫–æ–≥–¥–∞ CommitPilot —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Ä—è–¥–æ–º —Å –ø—Ä–æ–µ–∫—Ç–æ–º
    SCRIPT_PATH="$(dirname "$0")/../../CommitPilot/auto_commit.py"
else
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—É—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
    if [ -n "$COMMITPILOT_PATH" ]; then
        SCRIPT_PATH="$COMMITPILOT_PATH/auto_commit.py"
    else
        echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Å–∫—Ä–∏–ø—Ç auto_commit.py. –ó–∞–¥–∞–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é COMMITPILOT_PATH."
        exit 0
    fi
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Å–∫—Ä–∏–ø—Ç
if [ ! -f "$SCRIPT_PATH" ]; then
    echo "‚ö†Ô∏è –°–∫—Ä–∏–ø—Ç auto_commit.py –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ –ø—É—Ç–∏: $SCRIPT_PATH"
    exit 0
fi

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É Python
if command -v python3 &> /dev/null; then
    PYTHON_CMD="python3"
else
    PYTHON_CMD="python"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞
if [ -z "$(cat "$1" | grep -v "^#")" ]; then
    # –ü–æ–ª—É—á–∞–µ–º diff –∏–∑–º–µ–Ω–µ–Ω–∏–π
    DIFF=$(git diff --cached)
    STATUS=$(git status --porcelain)
    
    # –ï—Å–ª–∏ –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    if [ -n "$DIFF" ] || [ -n "$STATUS" ]; then
        echo "ü§ñ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –∫–æ–º–º–∏—Ç–∞ —Å –ø–æ–º–æ—â—å—é AI..."
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
        COMMIT_MSG=$($PYTHON_CMD "$SCRIPT_PATH" --get-message 2>/dev/null)
        
        # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Ñ–∞–π–ª
        if [ -n "$COMMIT_MSG" ]; then
            echo "$COMMIT_MSG" > "$1"
            echo "‚úÖ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞: $COMMIT_MSG"
        fi
    fi
fi

exit 0 